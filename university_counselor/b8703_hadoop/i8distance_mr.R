library(rhdfs)
hdfs.init()
library(rmr2)

# HDFS 상의 taxi 자료 파일 확인
hdfs.ls("/data/taxi/combined")
# 폴더에 포함된 파일 목록 files에 할당
files <- hdfs.ls("/data/taxi/combined")$file; files

hdfs.get("/data/taxi/combined/info.csv", "/home/u20173208/tmp/info.csv")
hdfs.get("/data/taxi/combined/sample_combined1.csv", "/home/u20173208/tmp/sample_combined1.csv")

# info.csv에 포함된 변수 이름과 클래스 정보 읽기
mr <- mapreduce(input = files[1], 
                input.format = make.input.format(
                  format = "csv", sep=",", stringsAsFactors=F)
)
res <- from.dfs(mr) 
ress <- values(res)
colnames.tmp <- as.character(ress[,1]); colnames.tmp
class.tmp <- as.character(ress[,2]); class.tmp 
# 변수 이름
colnames <- colnames.tmp[-1]; colnames
# 변수 클래스 
class <- class.tmp[-1]; class 
class[c(6,8,9,10)] <- "numeric"

print(colnames)
print(class)
cbind(colnames, class)

# 자료의 input format 지정
input.format <- make.input.format( 
  format = "csv", sep = ",", 
  stringsAsFactors = F, 
  col.names = colnames, colClasses = class)
files <- files[-1]
files

# payment_type를 key로 fare_amount를 value로 반환
map.fun <- function(k, v){
  # v[, 2]: medallion
  # v[,4]: payment_type
  # v[,6]: fare_amount 
  keyval(v[,17],1)  
}

# payment_type을 key로 fare_amount의 합을 value로 반환
reduce.fun <- function(k, v){
  keyval(k,sum(v))
}

# mapreduce 프레임워크 실행
# 파일 하나만 입력 자료로 사용
mr <- mapreduce( input = files[1], 
                 input.format = input.format, 
                 map = map.fun, 
                 reduce = reduce.fun )
from.dfs(mr)

# 모든 파일을 입력 자료로 사용
mr <- mapreduce( input = files, 
                 input.format = input.format, 
                 map = map.fun, 
                 reduce = reduce.fun )
from.dfs(mr)
# $key
#    [1] 0.00 0.01 0.02 0.03 0.04 0.05 0.06 0.07 0.08 0.09 0.10 0.11 0.12 0.13 0.14 0.15 0.16 0.17 0.18 0.19
#   [21] 0.20 0.21 0.22 0.23 0.24 0.25 0.26 0.27 0.28 0.29 0.30 0.31 0.32 0.33 0.34 0.35 0.36 0.37 0.38 0.39
#   [41] 0.40 0.41 0.42 0.43 0.44 0.45 0.46 0.47 0.48 0.49 0.50 0.51 0.52 0.53 0.54 0.55 0.56 0.57 0.58 0.59
#   [61] 0.60 0.61 0.62 0.63 0.64 0.65 0.66 0.67 0.68 0.69 0.70 0.71 0.72 0.73 0.74 0.75 0.76 0.77 0.78 0.79
#   [81] 0.80 0.81 0.82 0.83 0.84 0.85 0.86 0.87 0.88 0.89 0.90 0.91 0.92 0.93 0.94 0.95 0.96 0.97 0.98 0.99
#  [101] 1.00 1.01 1.02 1.03 1.04 1.05 1.06 1.07 1.08 1.09 1.10 1.11 1.12 1.13 1.14 1.15 1.16 1.17 1.18 1.19
#  [121] 1.20 1.21 1.22 1.23 1.24 1.25 1.26 1.27 1.28 1.29 1.30 1.31 1.32 1.33 1.34 1.35 1.36 1.37 1.38 1.39
#  [141] 1.40 1.41 1.42 1.43 1.44 1.45 1.46 1.47 1.48 1.49 1.50 1.51 1.52 1.53 1.54 1.55 1.56 1.57 1.58 1.59
#  [161] 1.60 1.61 1.62 1.63 1.64 1.65 1.66 1.67 1.68 1.69 1.70 1.71 1.72 1.73 1.74 1.75 1.76 1.77 1.78 1.79
#  [181] 1.80 1.81 1.82 1.83 1.84 1.85 1.86 1.87 1.88 1.89 1.90 1.91 1.92 1.93 1.94 1.95 1.96 1.97 1.98 1.99
#  [201] 2.00 2.01 2.02 2.03 2.04 2.05 2.06 2.07 2.08 2.09 2.10 2.11 2.12 2.13 2.14 2.15 2.16 2.17 2.18 2.19
#  [221] 2.20 2.21 2.22 2.23 2.24 2.25 2.26 2.27 2.28 2.29 2.30 2.31 2.32 2.33 2.34 2.35 2.36 2.37 2.38 2.39
#  [241] 2.40 2.41 2.42 2.43 2.44 2.45 2.46 2.47 2.48 2.49 2.50 2.51 2.52 2.53 2.54 2.55 2.56 2.57 2.58 2.59
#  [261] 2.60 2.61 2.62 2.63 2.64 2.65 2.66 2.67 2.68 2.69 2.70 2.71 2.72 2.73 2.74 2.75 2.76 2.77 2.78 2.79
#  [281] 2.80 2.81 2.82 2.83 2.84 2.85 2.86 2.87 2.88 2.89 2.90 2.91 2.92 2.93 2.94 2.95 2.96 2.97 2.98 2.99
#  [301] 3.00 3.01 3.02 3.03 3.04 3.05 3.06 3.07 3.08 3.09 3.10 3.11 3.12 3.13 3.14 3.15 3.16 3.17 3.18 3.19
#  [321] 3.20 3.21 3.22 3.23 3.24 3.25 3.26 3.27 3.28 3.29 3.30 3.31 3.32 3.33 3.34 3.35 3.36 3.37 3.38 3.39
#  [341] 3.40 3.41 3.42 3.43 3.44 3.45 3.46 3.47 3.48 3.49 3.50 3.51 3.52 3.53 3.54 3.55 3.56 3.57 3.58 3.59
#  [361] 3.60 3.61 3.62 3.63 3.64 3.65 3.66 3.67 3.68 3.69 3.70 3.71 3.72 3.73 3.74 3.75 3.76 3.77 3.78 3.79
#  [381] 3.80 3.81 3.82 3.83 3.84 3.85 3.86 3.87 3.88 3.89 3.90 3.91 3.92 3.93 3.94 3.95 3.96 3.97 3.98 3.99
#  [401] 4.00 4.01 4.02 4.03 4.04 4.05 4.06 4.07 4.08 4.09 4.10 4.11 4.12 4.13 4.14 4.15 4.16 4.17 4.18 4.19
#  [421] 4.20 4.21 4.22 4.23 4.24 4.25 4.26 4.27 4.28 4.29 4.30 4.31 4.32 4.33 4.34 4.35 4.36 4.37 4.38 4.39
#  [441] 4.40 4.41 4.42 4.43 4.44 4.45 4.46 4.47 4.48 4.49 4.50 4.51 4.52 4.53 4.54 4.55 4.56 4.57 4.58 4.59
#  [461] 4.60 4.61 4.62 4.63 4.64 4.65 4.66 4.67 4.68 4.69 4.70 4.71 4.72 4.73 4.74 4.75 4.76 4.77 4.78 4.79
#  [481] 4.80 4.81 4.82 4.83 4.84 4.85 4.86 4.87 4.88 4.89 4.90 4.91 4.92 4.93 4.94 4.95 4.96 4.97 4.98 4.99
#  [501] 5.00 5.01 5.02 5.03 5.04 5.05 5.06 5.07 5.08 5.09 5.10 5.11 5.12 5.13 5.14 5.15 5.16 5.17 5.18 5.19
#  [521] 5.20 5.21 5.22 5.23 5.24 5.25 5.26 5.27 5.28 5.29 5.30 5.31 5.32 5.33 5.34 5.35 5.36 5.37 5.38 5.39
#  [541] 5.40 5.41 5.42 5.43 5.44 5.45 5.46 5.47 5.48 5.49 5.50 5.51 5.52 5.53 5.54 5.55 5.56 5.57 5.58 5.59
#  [561] 5.60 5.61 5.62 5.63 5.64 5.65 5.66 5.67 5.68 5.69 5.70 5.71 5.72 5.73 5.74 5.75 5.76 5.77 5.78 5.79
#  [581] 5.80 5.81 5.82 5.83 5.84 5.85 5.86 5.87 5.88 5.89 5.90 5.91 5.92 5.93 5.94 5.95 5.96 5.97 5.98 5.99
#  [601] 6.00 6.01 6.02 6.03 6.04 6.05 6.06 6.07 6.08 6.09 6.10 6.11 6.12 6.13 6.14 6.15 6.16 6.17 6.18 6.19
#  [621] 6.20 6.21 6.22 6.23 6.24 6.25 6.26 6.27 6.28 6.29 6.30 6.31 6.32 6.33 6.34 6.35 6.36 6.37 6.38 6.39
#  [641] 6.40 6.41 6.42 6.43 6.44 6.45 6.46 6.47 6.48 6.49 6.50 6.51 6.52 6.53 6.54 6.55 6.56 6.57 6.58 6.59
#  [661] 6.60 6.61 6.62 6.63 6.64 6.65 6.66 6.67 6.68 6.69 6.70 6.71 6.72 6.73 6.74 6.75 6.76 6.77 6.78 6.79
#  [681] 6.80 6.81 6.82 6.83 6.84 6.85 6.86 6.87 6.88 6.89 6.90 6.91 6.92 6.93 6.94 6.95 6.96 6.97 6.98 6.99
#  [701] 7.00 7.01 7.02 7.03 7.04 7.05 7.06 7.07 7.08 7.09 7.10 7.11 7.12 7.13 7.14 7.15 7.16 7.17 7.18 7.19
#  [721] 7.20 7.21 7.22 7.23 7.24 7.25 7.26 7.27 7.28 7.29 7.30 7.31 7.32 7.33 7.34 7.35 7.36 7.37 7.38 7.39
#  [741] 7.40 7.41 7.42 7.43 7.44 7.45 7.46 7.47 7.48 7.49 7.50 7.51 7.52 7.53 7.54 7.55 7.56 7.57 7.58 7.59
#  [761] 7.60 7.61 7.62 7.63 7.64 7.65 7.66 7.67 7.68 7.69 7.70 7.71 7.72 7.73 7.74 7.75 7.76 7.77 7.78 7.79
#  [781] 7.80 7.81 7.82 7.83 7.84 7.85 7.86 7.87 7.88 7.89 7.90 7.91 7.92 7.93 7.94 7.95 7.96 7.97 7.98 7.99
#  [801] 8.00 8.01 8.02 8.03 8.04 8.05 8.06 8.07 8.08 8.09 8.10 8.11 8.12 8.13 8.14 8.15 8.16 8.17 8.18 8.19
#  [821] 8.20 8.21 8.22 8.23 8.24 8.25 8.26 8.27 8.28 8.29 8.30 8.31 8.32 8.33 8.34 8.35 8.36 8.37 8.38 8.39
#  [841] 8.40 8.41 8.42 8.43 8.44 8.45 8.46 8.47 8.48 8.49 8.50 8.51 8.52 8.53 8.54 8.55 8.56 8.57 8.58 8.59
#  [861] 8.60 8.61 8.62 8.63 8.64 8.65 8.66 8.67 8.68 8.69 8.70 8.71 8.72 8.73 8.74 8.75 8.76 8.77 8.78 8.79
#  [881] 8.80 8.81 8.82 8.83 8.84 8.85 8.86 8.87 8.88 8.89 8.90 8.91 8.92 8.93 8.94 8.95 8.96 8.97 8.98 8.99
#  [901] 9.00 9.01 9.02 9.03 9.04 9.05 9.06 9.07 9.08 9.09 9.10 9.11 9.12 9.13 9.14 9.15 9.16 9.17 9.18 9.19
#  [921] 9.20 9.21 9.22 9.23 9.24 9.25 9.26 9.27 9.28 9.29 9.30 9.31 9.32 9.33 9.34 9.35 9.36 9.37 9.38 9.39
#  [941] 9.40 9.41 9.42 9.43 9.44 9.45 9.46 9.47 9.48 9.49 9.50 9.51 9.52 9.53 9.54 9.55 9.56 9.57 9.58 9.59
#  [961] 9.60 9.61 9.62 9.63 9.64 9.65 9.66 9.67 9.68 9.69 9.70 9.71 9.72 9.73 9.74 9.75 9.76 9.77 9.78 9.79
#  [981] 9.80 9.81 9.82 9.83 9.84 9.85 9.86 9.87 9.88 9.89 9.90 9.91 9.92 9.93 9.94 9.95 9.96 9.97 9.98 9.99
#  [ reached getOption("max.print") -- omitted 2991 entries ]

# $val
#    [1]  56540   1808   1563   1531   1602   1873   1959   2087   2239   2197  11116   2225   2054   2121
#   [15]   1950   2016   2031   1982   1869   1899  19718   1997   2032   2088   2228   2356   2510   2553
#   [29]   2874   2974  43302   3367   3610   3859   4285   4480   4794   5099   5327   5594  79684   6206
#   [43]   6699   7084   7336   7772   8306   8390   8937   9185 118519   9837  10295  10501  10975  11128
#   [57]  11455  11800  11956  12507 151096  13006  13181  13475  13729  13816  14240  14509  14812  14880
#   [71] 174540  15430  15543  15771  15835  16190  16204  16454  16389  16654 187221  16951  16674  17060
#   [85]  17253  17129  17044  17239  17274  17229 192928  17522  17353  17511  17152  17289  17399  17480
#   [99]  17641  17468 218077  17573  17853  17439  17606  17134  17354  17201  17409  17332 186988  17601
#  [113]  17006  16949  17014  16841  16735  16569  16758  16818 180186  16727  16204  16292  16327  16247
#  [127]  16131  16227  15854  16156 170690  15716  15378  15490  15416  15654  15174  15154  14932  15279
#  [141] 163575  15200  15161  14795  14738  14658  14348  14459  14386  14456 154669  14342  14066  14121
#  [155]  13904  14005  13912  13812  13746  13426 146374  13341  13486  13220  13074  13068  13085  13231
#  [169]  12555  12860 135959  12724  12496  12333  12620  12273  12310  12329  12201  11912 126784  11860
#  [183]  11838  11609  11344  11359  11381  11356  11185  11005 118183  11225  11021  10818  11034  10758
#  [197]  10525  10595  10382  10232 129585  10231  10229  10054  10207   9820  10144   9886   9817   9772
#  [211] 102478   9590   9528   9511   9396   9307   9250   9248   9061   9178  95194   8789   8720   8847
#  [225]   8534   8551   8680   8380   8615   8341  88562   8242   8181   8126   8142   7845   7988   7808
#  [239]   7858   7869  82918   7619   7808   7515   7490   7528   7478   7259   7174   7159  76859   7248
#  [253]   7114   7034   7012   6986   7028   6937   6734   6753  71488   6734   6662   6598   6528   6600
#  [267]   6331   6395   6449   6365  67178   6317   6155   6015   6173   6200   5957   6043   5919   5896
#  [281]  63581   5947   5826   5845   5742   5694   5603   5597   5637   5423  58533   5379   5392   5329
#  [295]   5201   5228   5381   5268   5202   5155  63100   5204   5081   4911   4878   5022   4927   4928
#  [309]   4829   4830  51691   4904   4933   4734   4781   4617   4654   4723   4604   4637  48441   4420
#  [323]   4481   4445   4557   4356   4316   4383   4238   4398  45651   4207   4229   4189   4174   4038
#  [337]   4036   4187   4168   3896  42704   4088   3889   3925   3855   3924   3871   3860   3815   3809
#  [351]  40100   3711   3628   3757   3644   3652   3658   3615   3679   3598  38049   3550   3505   3498
#  [365]   3414   3444   3405   3414   3355   3429  35353   3265   3189   3360   3191   3220   3244   3214
#  [379]   3090   3203  33054   3092   3085   3126   2949   2948   2948   2958   2918   3013  31358   2885
#  [393]   2846   2834   2801   2769   2765   2834   2807   2870  35047   2793   2826   2660   2654   2680
#  [407]   2640   2621   2654   2663  27640   2686   2634   2572   2444   2555   2550   2533   2478   2461
#  [421]  26353   2475   2444   2424   2390   2394   2414   2375   2354   2380  25003   2252   2358   2296
#  [435]   2291   2226   2255   2334   2253   2173  23823   2221   2230   2149   2156   2154   2103   2151
#  [449]   2180   2115  22594   2067   2090   2033   2010   2011   2011   2071   2053   1992  21361   2030
#  [463]   2050   1942   1968   1983   1923   1924   1873   1814  20505   1894   1876   1895   1939   1802
#  [477]   1866   1846   1879   1819  19595   1860   1797   1795   1736   1730   1779   1786   1771   1769
#  [491]  18746   1742   1752   1701   1769   1702   1692   1686   1670   1732  20583   1628   1693   1682
#  [505]   1615   1675   1649   1679   1557   1594  16928   1541   1663   1516   1591   1524   1595   1574
#  [519]   1514   1525  16353   1483   1527   1533   1496   1498   1472   1459   1498   1412  15419   1439
#  [533]   1530   1501   1521   1455   1414   1395   1406   1404  14762   1369   1376   1374   1362   1315
#  [547]   1324   1353   1287   1357  14132   1371   1269   1283   1296   1289   1266   1357   1230   1302
#  [561]  13605   1249   1262   1252   1231   1255   1270   1285   1211   1176  12884   1264   1205   1201
#  [575]   1144   1179   1155   1196   1161   1177  12186   1140   1158   1132   1147   1144   1126   1111
#  [589]   1179   1147  11870   1116   1064   1120   1012   1081   1059   1120   1069   1089  13242   1046
#  [603]   1035   1054    987   1067   1073   1021   1100   1005  10662   1024    956   1013    983    986
#  [617]    964    976    941   1013  10224   1027    965    923    961    955    957    937    895    890
#  [631]   9945    884    909    911    929    910    905    885    898    933   9454    878    834    907
#  [645]    819    847    866    861    888    900   9109    870    821    847    843    816    818    824
#  [659]    791    758   8586    829    725    835    807    782    817    765    819    810   8312    800
#  [673]    686    795    795    807    773    753    761    759   8052    776    791    769    738    712
#  [687]    729    642    667    736   7577    685    744    697    749    739    697    693    702    728
#  [701]   8357    677    698    687    681    676    664    696    675    667   7010    618    612    670
#  [715]    653    603    664    638    680    584   6447    596    610    638    609    625    564    615
#  [729]    589    645   6490    552    573    623    604    606    609    603    604    599   6264    594
#  [743]    628    646    597    622    560    550    592    571   6226    563    577    592    561    584
#  [757]    588    547    565    547   5988    603    587    550    559    547    509    531    560    531
#  [771]   5746    555    527    542    525    524    542    506    550    563   5600    551    469    540
#  [785]    464    550    525    520    485    524   5540    491    531    539    544    533    524    518
#  [799]    496    483   6653    523    496    531    512    522    556    533    546    529   5677    481
#  [813]    541    540    502    534    506    557    512    594   5492    509    512    555    492    525
#  [827]    520    508    541    504   5462    504    505    554    515    534    512    496    513    530
#  [841]   5470    502    491    540    533    587    523    475    518    508   5463    514    524    546
#  [855]    521    542    545    532    570    558   5683    549    542    551    521    523    549    481
#  [869]    510    542   5682    532    516    511    563    544    549    540    566    497   5703    535
#  [883]    546    529    571    534    509    530    579    551   5700    542    538    522    572    523
#  [897]    521    571    545    587   6704    535    554    541    544    546    583    550    523    566
#  [911]   5875    522    565    595    528    544    542    544    538    500   5740    546    554    540
#  [925]    527    523    554    575    551    566   5687    504    547    516    565    554    579    532
#  [939]    540    556   5574    538    532    528    525    516    490    535    478    498   5530    541
#  [953]    501    493    518    512    537    526    529    539   5503    511    466    538    529    496
#  [967]    495    514    507    497   5402    526    499    512    523    490    487    487    503    513
#  [981]   5364    536    468    519    519    501    540    445    529    531   5344    511    507    487
#  [995]    546    452    460    465    532    491
#  [ reached getOption("max.print") -- omitted 2991 entries ]